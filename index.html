<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nearest Animals (Live Location)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    h1 { margin-top: 0; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 14px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer; }
    code { background: #f6f8fa; padding: 2px 6px; border-radius: 6px; }
    .muted { color: #666; font-size: 0.9em; }
    .error { color: #b00020; }
    .list { margin-top: 16px; }
    .item { padding: 10px 0; border-bottom: 1px dashed #e5e5e5; }
    .item:last-child { border-bottom: none; }
    .warn { background: #fff8e1; border: 1px solid #ffe082; padding: 10px 12px; border-radius: 10px; }
    input[type="number"], input[type="text"] { padding: 6px 8px; border-radius: 8px; border: 1px solid #ccc; }
    label { display: inline-flex; align-items: center; gap: 8px; }
  </style>
</head>
<body>
  <h1>Nearest Animals (Live Location)</h1>

  <div class="card warn" id="secureHelp" style="display:none">
    <b>Heads up:</b> Geolocation only works on <b>HTTPS</b> or on <b>http://localhost</b> (secure context).<br/>
    If you opened this page via a LAN IP (e.g., <code>http://192.168.x.x:8000</code>) the browser will block it.
    Try one of:
    <ul>
      <li>Open <code>http://localhost:8000</code> on this machine, or</li>
      <li>Use a tunnel like <code>ngrok http 8000</code> and open the <b>https://</b> URL, or</li>
      <li>Run the server with HTTPS (self-signed cert) and visit <b>https://</b>.</li>
    </ul>
  </div>

  <p class="muted">This page reads your current location (via the browser) and asks a local FastAPI server for the closest animals from your CSV.</p>

  <div class="row">
    <label>k:
      <input id="k" type="number" value="5" min="1" style="width: 64px;"/>
    </label>
    <button id="refreshBtn">Refresh once</button>
    <button id="watchBtn">Start watching</button>
    <button id="stopBtn">Stop watching</button>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="row">
      <label>Manual lat:
        <input id="manLat" type="text" placeholder="e.g. -1.2921"/>
      </label>
      <label>Manual lon:
        <input id="manLon" type="text" placeholder="e.g. 36.8219"/>
      </label>
      <button id="useManualBtn">Use manual once</button>
    </div>
    <p class="muted">Use this if your browser blocks geolocation or for testing other places.</p>
  </div>

  <p id="status" class="muted"></p>
  <div id="results" class="list"></div>

  <script>
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const kEl = document.getElementById('k');
    const refreshBtn = document.getElementById('refreshBtn');
    const watchBtn = document.getElementById('watchBtn');
    const stopBtn = document.getElementById('stopBtn');
    const manLatEl = document.getElementById('manLat');
    const manLonEl = document.getElementById('manLon');
    const useManualBtn = document.getElementById('useManualBtn');
    const secureHelp = document.getElementById('secureHelp');

    // Show secure-origin help if not in a secure context
    if (!window.isSecureContext && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      secureHelp.style.display = 'block';
    }

    let watchId = null;

    function setStatus(msg, isError=false) {
      statusEl.textContent = msg;
      statusEl.className = isError ? 'error' : 'muted';
    }

    // Explain geolocation errors
    function geoErrorMessage(err) {
      if (!err || typeof err !== 'object') return 'Unknown error';
      switch (err.code) {
        case 1: return 'Permission denied. Allow location in your browser settings.';
        case 2: return 'Position unavailable. Try moving, toggling Wi‑Fi, or using manual input.';
        case 3: return 'Timeout while acquiring position.';
        default: return err.message || 'Unknown error';
      }
    }

    // Preflight permission check (helps users before they click)
    async function checkGeoPermission() {
      try {
        if (!('permissions' in navigator) || !navigator.permissions.query) return;
        const st = await navigator.permissions.query({ name: 'geolocation' });
        if (st.state === 'denied') {
          setStatus('Geolocation permission is denied. Use manual inputs or allow location access.', true);
        }
        st.onchange = () => {
          if (st.state === 'granted') setStatus('Geolocation granted. You can start watching.');
          else if (st.state === 'prompt') setStatus('Geolocation will prompt on first use.');
          else setStatus('Geolocation permission denied. Use manual inputs.', true);
        };
      } catch {}
    }

    async function callNearest(lat, lon, k=5) {
      try {
        setStatus(`Your position: ${lat.toFixed(6)}, ${lon.toFixed(6)} — fetching nearest ${k}...`);
        const resp = await fetch('/nearest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lat, lon, k: Number(k) })
        });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.detail || `HTTP ${resp.status}`);
        }
        const data = await resp.json();
        renderResults(data.results || []);
        setStatus(`Updated at ${new Date().toLocaleTimeString()}`);
      } catch (e) {
        setStatus(`Error: ${e.message}`, true);
      }
    }

    function renderResults(items) {
      resultsEl.innerHTML = '';
      if (!items.length) {
        resultsEl.innerHTML = '<div class="item">No results.</div>';
        return;
      }
      items.forEach((it, i) => {
        const div = document.createElement('div');
        div.className = 'item';
        const distNum = Number(it.Distance_km);
        const dist = Number.isFinite(distNum) ? ` — ${distNum.toFixed(2)} km` : '';
        div.textContent = `${i+1}. ${it.Common_name || '(unknown)'}${dist}  (${it.Latitude}, ${it.Longitude})`;
        resultsEl.appendChild(div);
      });
    }

    function getOnce() {
      const k = Number(kEl.value) || 5;
      if (!('geolocation' in navigator)) {
        setStatus('Geolocation not supported in this browser.', true);
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          callNearest(latitude, longitude, k);
        },
        err => setStatus('Geolocation error: ' + geoErrorMessage(err), true),
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    }

    function startWatch() {
      const k = Number(kEl.value) || 10;
      if (!('geolocation' in navigator)) {
        setStatus('Geolocation not supported in this browser.', true);
        return;
      }
      if (watchId !== null) return; // already watching
      watchId = navigator.geolocation.watchPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          callNearest(latitude, longitude, k);
        },
        err => {
          // Fallback to one-time position on unavailable/timeout, clear watch handle just in case
          const msg = geoErrorMessage(err);
          if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
          }
          setStatus('Geolocation watch error: ' + msg + ' — falling back to one-time position.', true);
          getOnce();
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
      setStatus('Watching your location... move around to see nearby animals update.');
    }

    function stopWatch() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        setStatus('Stopped watching location.');
      }
    }

    function useManualOnce() {
      const k = Number(kEl.value) || 5;
      const lat = parseFloat(manLatEl.value);
      const lon = parseFloat(manLonEl.value);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
        setStatus('Enter valid numbers for manual lat/lon.', true);
        return;
      }
      callNearest(lat, lon, k);
    }

    // Wire up buttons
    refreshBtn.addEventListener('click', getOnce);
    watchBtn.addEventListener('click', startWatch);
    stopBtn.addEventListener('click', stopWatch);
    useManualBtn.addEventListener('click', useManualOnce);

    // Run permission preflight on load
    checkGeoPermission();
  </script>
</body>
</html>
